@import services.users.User
@import services.rules.PathRule
@import util.RichDuration._

@(users: List[User], rules: List[PathRule])

@main("Migration") {
    <div>
        <h1>AuthThingie Configuration Migration</h1>
        <p>
            Hello there! I have decided to move configuration storage out of the config file and in to a SQLite database. This
            database has been created already, but it is currently empty. I would like to move all of your currently existing configuration
            in to it. The following is what I will be migrating:
        </p>
        <div class="container-fluid row py-3">
        @if(users.nonEmpty) {
            <h3>Users</h3>
            <div class="table-responsive">
                <table class="table table-striped table-sm user-table">
                    <thead>
                        <tr>
                            <th scope="col">Username</th>
                            <th scope="col">Uses TOTP?</th>
                            <th scope="col">Duo Enabled?</th>
                            <th scope="col">Roles</th>
                        </tr>
                    </thead>
                    <tbody>
                    @for(user <- users) {
                        <tr>
                            <td>
                            @user.username
                            </td>
                            <td>
                            @if(user.usesTotp) {
                                ✅
                            } else {
                                ❌
                            }
                            </td>
                            <td>
                            @if(user.duoEnabled) {
                                ✅
                            } else {
                                ❌
                            }
                            </td>
                            <td>
                                @if(user.admin) {
                                    <span class="badge badge-danger">Admin</span>
                                }
                                @for(role <- user.roles) {
                                    <span class="badge badge-primary">@role</span>
                                }
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        }
        </div>

        <div class="container-fluid row py-3">
        @if(rules.nonEmpty) {
            <h3>Rules</h3>
            <div class="table-responsive">
                <table class="table table-striped table-sm rule-table">
                    <thead>
                        <tr>
                            <th scope="col">Name</th>
                            <th scope="col">Protocol</th>
                            <th scope="col">Host</th>
                            <th scope="col">Path</th>
                            <th scope="col">Timeout</th>
                            <th scope="col">Permitted Roles</th>
                        </tr>
                    </thead>
                    <tbody>
                    @for(rule <- rules) {
                        <tr>
                            <td>
                            @rule.name
                            </td>
                            <td>
                            @rule.protocolPattern.getOrElse("*")
                            </td>
                            <td>
                            @rule.hostPattern.getOrElse("*")
                            </td>
                            <td>
                            @rule.pathPattern.getOrElse("*")
                            </td>
                            <td>
                            @if(rule.public) {
                                ∞
                            } else {
                                @rule.timeout.map(_.prettyPrint).getOrElse("Default")
                            }
                            </td>
                            <td>
                            @if(rule.public) {
                                <span class="badge badge-success">Public Access</span>
                            } else {
                                @if(rule.permittedRoles.isEmpty) {
                                    <span class="badge badge-danger">Admin Only</span>
                                } else {
                                    @for(role <- rule.permittedRoles) {
                                        <span class="badge badge-primary">@role</span>
                                    }
                                }
                            }
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
        }

        <p>
            Once you click the button below, the migration will take palce. I will not be removing anything from the
            config file, but once this migration is done, the <strong>users</strong> and <strong>rules</strong> sections
            will be ignored from the config file and read from the database instead. There will be config pages for admins
            to add and remove users, etc. Click the button below to perform the migration...this will take a few seconds,
            so don't panic
        </p>

        <div>
            <a class="btn btn-danger" href="@routes.FirstTimeSetupController.completeMigration()">Migrate</a>
        </div>
    </div>
}